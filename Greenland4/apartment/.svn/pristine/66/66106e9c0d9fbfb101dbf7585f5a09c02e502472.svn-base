<template>
  <div>
    <div v-if="isshow" class="wrap">
      <Row type="flex" justify="space-between" style="padding-bottom:10px;">
        <Col>
        <Button type="ghost" @click="addsite">新建</Button>
        </Col>
        <Col>
        <span>开始时间：</span>
        <DatePicker type="date" v-model="startDate" placeholder="选择时间"></DatePicker>
        <span>结束时间：</span>
        <DatePicker type="date" v-model="endDate" placeholder="选择时间"></DatePicker>
        <Select v-model="searchType" style="width:100px">
          <Option v-for="item in searchTypeList" :value="item.key" :key="item.key">{{ item.title }}</Option>
        </Select>
        <Input clearable v-if="searchType != 'isEnable'" v-model="searchValue" placeholder="请输入搜索的内容"  style="width: 200px"></Input>
        <Select v-if="searchType == 'isEnable'" v-model="searchIsEnable" style="width:200px">
          <Option :value="0">启用</Option>  
          <Option :value="1">禁用</Option>
        </Select>
        <Button icon="ivu-icon ivu-icon-search" @click="search"></Button>
        </Col>
      </Row>
      <Table @on-row-dblclick="editsite" border :columns="sitecol" :data="sitedata"></Table>
      <div style="margin: 10px;overflow: hidden">
        <div style="float: right;">
          <Page :total="total" :page-size="10" @on-change="changePage"></Page>
        </div>
      </div>
    </div>

    <Form class="wrap" v-else ref="formValidate" :rules="ruleValidate" :model="formValidate" :label-width="80">
      <Row>
        <Col :xs="24" :lg="12">
        <FormItem label="站点编码" prop="siteNum">
          <Input :disabled="operationstatus=='add'?false:true" v-model="formValidate.siteNum" @on-blur="isExist"></Input>
        </FormItem>
        </Col>
        <Col :xs="24" :lg="12">
        <FormItem label="站点名称" prop="siteName">
          <Input v-model="formValidate.siteName"></Input>
        </FormItem>
        </Col>

      </Row>
      <Row>
        <Col :xs="24" :lg="12">
        <FormItem label="站点描述" prop="siteRemark">
          <Input v-model="formValidate.siteRemark"></Input>
        </FormItem>
        </Col>
        <Col :xs="24" :lg="12">
        <FormItem label="站点状态">
          <RadioGroup v-model="formValidate.isEnable">
            <Radio :label="0">启用</Radio>
            <Radio :label="1">禁用</Radio>
          </RadioGroup>
        </FormItem>
        </Col>
      </Row>
      <Row>
        <Col span="24">
        <Upload name="logo" :on-success="handleSuccess" :action='$util.ajaxUrl+"/digiops/upload/picture"'>
          <Button type="ghost" icon="ios-cloud-upload-outline">上传站点头像</Button>
          <p v-if="sitelogotap">必须上传站点头像</p>
        </Upload>
        <img :src="siteLogo" alt="">
        </Col>
        <FormItem>
          <Button type="primary" @click="handleSubmit('formValidate',formValidate)">保存</Button>
          <Button type="ghost" @click="handleReset('formValidate')" style="margin-left: 8px">取消</Button>
        </FormItem>
      </Row>
    </Form>
  </div>
</template>
<script>
import {
  upload,
  siteadd,
  sitelist,
  siteIsExist,
  siteupdate,
  siteid
} from "../../api/index";
export default {
  name: "site",
  data() {
    return {
      searchIsEnable: "",
      startDate: "",
      endDate: "",
      sitelogotap: false,
      operationstatus: "add",
      siteLogo: "",
      searchValue: "",
      searchType: "siteNum",
      searchTypeList: [
        {
          title: "站点编码",
          key: "siteNum"
        },
        {
          title: "站点名称",
          key: "siteName"
        },
        {
          title: "状态",
          key: "isEnable"
        }
      ],
      formValidate: {
        isEnable: 0,
        siteNum: "",
        siteName: "",
        siteRemark: "",
        siteLogo: ""
      },
      ruleValidate: {
        siteName: [
          {
            required: true,
            message: "站点名称不能为空",
            trigger: "blur"
          }
        ],
        siteNum: [
          {
            required: true,
            message: "站点编码不能为空",
            trigger: "blur"
          }
        ]
      },
      isshow: true,
      newarr: [],
      total: 0,
      selectList: [],
      sitecol: [
        {
          type: "selection",
          width: 60,
          align: "center"
        },
        {
          title: "站点编码",
          key: "siteNum"
        },
        {
          title: "站点名称",
          key: "siteName"
        },
        {
          title: "描述",
          key: "siteRemark"
        },
        {
          title: "创建时间",
          key: "createTime",
          sortable: true
        },
        {
          title: "状态",
          key: "isEnable"
        }
      ],
      sitedata: []
    };
  },
  created() {
    this.getformatdata({ pageSize: 10, startPage: 1 });
  },
  methods: {
    search() {
      let searchData = {
        pageSize: 10,
        startPage: 1,
        startDate: this.startDate,
        endDate: this.endDate
      };
      if (this.searchType == "isEnable") {
        searchData.isEnable = this.searchIsEnable;
      } else {
        searchData[this.searchType] = this.searchValue;
      }
      if (this.endDate != "" && this.startDate != "") {
        if (this.endDate >= this.startDate) {
          this.getformatdata(searchData);
        } else {
          this.$Message.info("结束时间应大于开始时间");
          this.endDate = "";
        }
      } else {
        this.getformatdata(searchData);
      }
    },
    isExist() {
      console.log();
      siteIsExist({ siteNum: this.formValidate.siteNum }).then(res => {
        if (!res.data.data) {
          this.$Message.info("站点编码重复");
          this.formValidate.siteNum = "";
        }
      });
    },
    formatDate(v) {
      return v + "ddddd";
    },
    handleSuccess(res, file) {
      console.log(res);
      this.formValidate.siteLogo = res.data;
      this.siteLogo = this.$util.ajaxUrl + "/digiops" + res.data;
    },
    changePage(startPage) {
      this.getformatdata({ pageSize: 10, startPage: startPage });
    },
    addsite() {
      this.isshow = false;
      this.operationstatus = "add";
      this.formValidate.isEnable = 0;
    },
    editsite(row, index) {
      this.isshow = false;
      console.log(row);
      siteid(row.uuid).then(res => {
        console.log(res);
        this.formValidate = {
          isEnable: res.data.data.isEnable,
          siteNum: res.data.data.siteNum,
          siteRemark: res.data.data.siteRemark,
          siteName: res.data.data.siteName,
          uuid: res.data.data.uuid,
          siteLogo: res.data.data.siteLogo
        };
        this.siteLogo =
          this.$util.ajaxUrl + "/digiops" + res.data.data.siteLogo;
      });
      this.operationstatus = "edit";
    },
    handleSubmit(name, data) {
      this.$refs[name].validate(valid => {
        if (valid) {
          this.$Message.success("Success!");
          this.isshow = true;
          if (this.formValidate.siteLogo == "") {
            this.sitelogotap = true;
          } else if (this.operationstatus == "add") {
            siteadd(this.formValidate).then(res => {
              this.getformatdata({ pageSize: 10, startPage: 1 });
            });
          } else {
            console.log(this.formValidate);
            siteupdate(this.formValidate).then(res => {
              this.getformatdata({ pageSize: 10, startPage: 1 });
            });
          }

          this.formValidate = {
            isEnable: 0,
            siteNum: "",
            siteName: "",
            siteRemark: "",
            siteLogo: ""
          };
          this.siteLogo = "";
        } else {
        }
      });
    },
    getformatdata(data) {
      sitelist(data).then(res => {
        console.log(res);
        this.sitedata = res.data.data.records;
        this.total = res.data.data.total;
        this.sitedata.forEach(item => {
          item.createTime = this.$util.formatTime(item.createTime);
          item.isEnable = item.isEnable == 0 ? "启用" : "禁用";
        });
      });
    },
    handleReset(name) {
      this.$refs[name].resetFields();
      this.isshow = true;
    }
  }
};
</script>
<style scoped>
</style>
